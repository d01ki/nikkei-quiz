{% extends "base.html" %}

{% block title %}クイズ - 日経クイズ練習アプリ{% endblock %}

{% block content %}
<div class="card">
    <div id="quiz-container">
        <!-- クイズ開始前 -->
        <div id="quiz-start" class="text-center">
            <h1 style="color: #2c3e50; margin-bottom: 1rem;">
                <i class="fas fa-brain" style="color: #3498db;"></i>
                日経テスト クイズ
            </h1>
            <p style="color: #7f8c8d; margin-bottom: 2rem; font-size: 1.1rem;">
                ランダムに出題される問題に挑戦しましょう
            </p>
            <button id="start-quiz-btn" class="btn btn-success btn-large">
                <i class="fas fa-play"></i>
                クイズを開始
            </button>
        </div>

        <!-- クイズ進行中 -->
        <div id="quiz-active" class="hidden">
            <!-- 問題情報 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <span id="category-badge" class="badge badge-category"></span>
                    <span id="difficulty-badge" class="badge badge-difficulty"></span>
                </div>
                <button id="next-question-btn" class="btn" onclick="loadQuestion()">
                    <i class="fas fa-forward"></i>
                    次の問題
                </button>
            </div>

            <!-- 問題 -->
            <div id="question-container">
                <h2 id="question-text" style="color: #2c3e50; margin-bottom: 2rem; line-height: 1.5;"></h2>
                
                <!-- 選択肢 -->
                <div id="options-container" class="options-grid">
                    <!-- 選択肢がここに挿入されます -->
                </div>

                <!-- 提出ボタン -->
                <div class="text-center" style="margin-top: 2rem;">
                    <button id="submit-btn" class="btn btn-large" disabled>
                        <i class="fas fa-check"></i>
                        回答する
                    </button>
                </div>
            </div>

            <!-- 結果表示 -->
            <div id="result-container" class="hidden">
                <div id="result-content"></div>
                <div class="text-center" style="margin-top: 2rem;">
                    <button id="continue-btn" class="btn btn-success btn-large">
                        <i class="fas fa-arrow-right"></i>
                        次の問題へ
                    </button>
                    <a href="{{ url_for('index') }}" class="btn" style="margin-left: 1rem;">
                        <i class="fas fa-home"></i>
                        ホームに戻る
                    </a>
                </div>
            </div>
        </div>

        <!-- ローディング -->
        <div id="loading" class="hidden text-center">
            <div class="loading"></div>
            <p style="margin-top: 1rem; color: #7f8c8d;">問題を読み込み中...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .badge {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-category {
        background: linear-gradient(145deg, #3498db, #2980b9);
        color: white;
    }

    .badge-difficulty {
        background: linear-gradient(145deg, #f39c12, #e67e22);
        color: white;
    }

    .options-grid {
        display: grid;
        gap: 1rem;
        margin: 2rem 0;
    }

    .option-item {
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
    }

    .option-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
        transition: left 0.5s;
    }

    .option-item:hover::before {
        left: 100%;
    }

    .option-item:hover {
        border-color: #3498db;
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
    }

    .option-item.selected {
        border-color: #2ecc71;
        background: linear-gradient(145deg, #d5f4e6, #a8e6cf);
        transform: scale(1.02);
    }

    .option-item.disabled {
        pointer-events: none;
        opacity: 0.7;
    }

    .option-letter {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        background: #3498db;
        color: white;
        border-radius: 50%;
        font-weight: 600;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .option-text {
        flex: 1;
        font-size: 1rem;
        line-height: 1.4;
    }

    .result-card {
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        animation: fadeIn 0.5s ease-out;
    }

    .result-correct {
        background: linear-gradient(145deg, #d5f4e6, #a8e6cf);
        border: 2px solid #27ae60;
    }

    .result-incorrect {
        background: linear-gradient(145deg, #fde8e8, #fbb6b6);
        border: 2px solid #e74c3c;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }

    .result-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .result-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .explanation-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        border-left: 4px solid #3498db;
    }

    .explanation-title {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .option-item {
            padding: 1rem;
        }
        
        .option-letter {
            width: 25px;
            height: 25px;
            margin-right: 0.8rem;
        }

        .option-text {
            font-size: 0.9rem;
        }

        .result-icon {
            font-size: 2.5rem;
        }

        .result-title {
            font-size: 1.3rem;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
let currentQuestion = null;
let selectedAnswer = null;

document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('start-quiz-btn');
    const submitBtn = document.getElementById('submit-btn');
    const continueBtn = document.getElementById('continue-btn');

    startBtn.addEventListener('click', startQuiz);
    submitBtn.addEventListener('click', submitAnswer);
    continueBtn.addEventListener('click', loadQuestion);
});

function startQuiz() {
    showLoading();
    loadQuestion();
}

function showLoading() {
    document.getElementById('quiz-start').classList.add('hidden');
    document.getElementById('quiz-active').classList.add('hidden');
    document.getElementById('loading').classList.remove('hidden');
}

function showQuizActive() {
    document.getElementById('quiz-start').classList.add('hidden');
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('quiz-active').classList.remove('hidden');
    document.getElementById('question-container').classList.remove('hidden');
    document.getElementById('result-container').classList.add('hidden');
}

function loadQuestion() {
    showLoading();
    selectedAnswer = null;
    
    fetch('/api/get_question')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('エラー: ' + data.error);
                return;
            }
            
            currentQuestion = data;
            displayQuestion(data);
            showQuizActive();
        })
        .catch(error => {
            console.error('エラー:', error);
            alert('問題の取得に失敗しました');
        });
}

function displayQuestion(question) {
    // カテゴリと難易度のバッジ
    document.getElementById('category-badge').textContent = question.category;
    document.getElementById('difficulty-badge').textContent = question.difficulty;
    
    // 問題文
    document.getElementById('question-text').textContent = question.question;
    
    // 選択肢
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const optionElement = document.createElement('div');
        optionElement.className = 'option-item';
        optionElement.onclick = () => selectOption(index);
        
        optionElement.innerHTML = `
            <div class="option-letter">${String.fromCharCode(65 + index)}</div>
            <div class="option-text">${option}</div>
        `;
        
        optionsContainer.appendChild(optionElement);
    });
    
    // 提出ボタンを無効化
    document.getElementById('submit-btn').disabled = true;
}

function selectOption(index) {
    // 既存の選択を解除
    document.querySelectorAll('.option-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // 新しい選択
    document.querySelectorAll('.option-item')[index].classList.add('selected');
    selectedAnswer = index;
    
    // 提出ボタンを有効化
    document.getElementById('submit-btn').disabled = false;
}

function submitAnswer() {
    if (selectedAnswer === null) return;
    
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.innerHTML = '<div class="loading"></div> 採点中...';
    submitBtn.disabled = true;
    
    // 選択肢を無効化
    document.querySelectorAll('.option-item').forEach(item => {
        item.classList.add('disabled');
    });
    
    fetch('/api/submit_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            answer: selectedAnswer
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('エラー: ' + data.error);
            return;
        }
        
        displayResult(data);
    })
    .catch(error => {
        console.error('エラー:', error);
        alert('回答の提出に失敗しました');
    });
}

function displayResult(result) {
    const resultContainer = document.getElementById('result-container');
    const resultContent = document.getElementById('result-content');
    
    const isCorrect = result.correct;
    const correctAnswer = result.correct_answer;
    
    // 正解の選択肢をハイライト
    document.querySelectorAll('.option-item').forEach((item, index) => {
        if (index === correctAnswer) {
            item.style.borderColor = '#27ae60';
            item.style.background = 'linear-gradient(145deg, #d5f4e6, #a8e6cf)';
        } else if (index === selectedAnswer && !isCorrect) {
            item.style.borderColor = '#e74c3c';
            item.style.background = 'linear-gradient(145deg, #fde8e8, #fbb6b6)';
        }
    });
    
    // 結果カードの内容
    const resultClass = isCorrect ? 'result-correct' : 'result-incorrect';
    const iconClass = isCorrect ? 'fa-check-circle' : 'fa-times-circle';
    const iconColor = isCorrect ? '#27ae60' : '#e74c3c';
    const resultTitle = isCorrect ? '正解！' : '不正解';
    
    resultContent.innerHTML = `
        <div class="result-card ${resultClass} text-center">
            <i class="fas ${iconClass} result-icon" style="color: ${iconColor};"></i>
            <div class="result-title" style="color: ${iconColor};">${resultTitle}</div>
            <p style="color: #2c3e50; font-size: 1.1rem;">
                正解は <strong>${String.fromCharCode(65 + correctAnswer)}</strong> でした
            </p>
        </div>
        
        ${result.explanation ? `
            <div class="explanation-card">
                <div class="explanation-title">
                    <i class="fas fa-lightbulb"></i>
                    解説
                </div>
                <p style="color: #2c3e50; line-height: 1.6;">${result.explanation}</p>
                ${result.source ? `<p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 1rem; font-style: italic;">出典: ${result.source}</p>` : ''}
            </div>
        ` : ''}
    `;
    
    // 問題コンテナを隠して結果を表示
    document.getElementById('question-container').classList.add('hidden');
    resultContainer.classList.remove('hidden');
}

// キーボードショートカット
document.addEventListener('keydown', function(e) {
    if (e.key >= '1' && e.key <= '4') {
        const index = parseInt(e.key) - 1;
        const options = document.querySelectorAll('.option-item');
        if (options[index] && !options[index].classList.contains('disabled')) {
            selectOption(index);
        }
    } else if (e.key === 'Enter') {
        const submitBtn = document.getElementById('submit-btn');
        const continueBtn = document.getElementById('continue-btn');
        
        if (!submitBtn.disabled && !submitBtn.classList.contains('hidden')) {
            submitAnswer();
        } else if (!continueBtn.classList.contains('hidden')) {
            loadQuestion();
        }
    }
});
</script>
{% endblock %}